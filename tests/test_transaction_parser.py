import unittest

from icondbtools.libs.block_database_raw_reader import TransactionParser


class MockDB(dict):
    def put(self, key, value):
        self.__setitem__(key, value)

    def get(self, key):
        return self.__getitem__(key)


class TestTransactionParser(unittest.TestCase):
    def setUp(self):
        self.v3_transactions: list = [{'version': '0x3', 'from': 'hx6e1dd0d4432620778b54b2bbc21ac3df961adf89',
                                       'to': 'cx0000000000000000000000000000000000000001', 'stepLimit': '0x70000000',
                                       'timestamp': '0x592401ffd2d8e', 'nid': '0x50', 'dataType': 'deploy',
                                       'data': {'contentType': 'application/zip',
                                                'content': '0x504b0304140000000800d66d254facf2a78f7a0100005802000021000000676f7665726e616e63652f676f7665726e616e63652f5f5f696e69745f5f2e70796592c14ec3301044effd8a517b01d4a6c009c12994222c502a3505c4d14d36e94aa96d6c87d0bf67138a04e264d93b1abf197b82d9d90c852dd9d4d7686335bbea4f46a30916d61d3cd7bb88cbf38b2ba8c52ac3bd6d4da9235b339a88e4890b32814ac82979c41d2175ba90e53899e2857c10392e93739cf482f171343ebd1187836db1d707181bd106120b0ea8b821d067412e828dd0ed5dc3da14848ee36eb8e6689288c5dbd1c26ea316b516bd935df55b071d07e05d8cee7a3eefba2ed10368627d3d6fbe4561fea416cb2c5fce0476903f9b864280a7f796bdc4dc1ea09db0147a2b848dee603d74ed4966d1f6ac9de728554e116c153bed495c4a0ed1f3b68d7f8afa2193bcbf0552953618a739543ec66d9aab7c2a1eaf6af3b07adee0355dafd36ca39639566bc893dca98d5a65b2bb479abde15165775390d424d7d0a7f33dbf40725f21957d5f39d11f80ca7e03054705575c482e53b7ba26d4f683bc913870e4f71cfa870c82578a4bc37b8ec34f08ff4325a32f504b0304140000000800d66d254fad3cec03ef160000717c000023000000676f7665726e616e63652f676f7665726e616e63652f676f7665726e616e63652e7079ed3dfd73dbb692bffbafc053664e524e511da7e9ebe8eace536d25d1d5b57396ec36e766585a82643692a847528e757efedf6f1700417c5294e236ed9b6aa68d452e16bb8bfd02b0809e90674f9f91513c8e16d30e596593675fe393bdbd27e4285eae93687a939183fde75f93fed1d9297915af16e3308be2c5de13003989467491d23181a73421d90d25dd6538827fc49b16b9a4490ae0e4a0bd4f1a085013af6acdff020ceb7845e6e19a2ce28cac520a28a2944ca21925f46e449719891640dd7c398bc2c588928f5176c3ba1148da80e29d40115f6721408700bf846f13158e841923f826cb969d2fbef8f8f1633b6484b6e364fac58c03a55f9cf48f7aa783de332096815f2c66344d4942ffb98a1260f37a4dc225d0320aaf81c259f891c40909a7098577598cb47e4ca20c44d922693cc93e8609052ce328cd92e87a956982ca29037e55001055b820b5ee80f40735f25d77d01fb400c78ffde19bb38b21f9b17b7ede3d1df67b0372764e60488efbc3fed9297c7b45baa7efc8f7fdd3e316a12026e886de2d13a41f888c5084748cf21a50aa1130893941e9928ea2493402be16d35538a5641adfd26401ec90254de6518a0399027963c0328be651c63421b5996aefed4d92784ea211bca6c92d3c450ae224234ff7f686ddd7e490d45f33ec38acf5bde3de7717f8f055384be9deded1c5f979ef748850a35592d04556df3bedfdc41e2ce81d7c1b0cbbc38b017e4f818a558a28de9e9cbd0b863f056fba8337f8664c97b3783dbc7b13a637f5bdee05884a7d1daec65196bf85d6670378df3f7d7526dac66994f51793b8be77d93de91f07bccbe0fbde3becf78a7f6d11bddf16d1fa79bf27280ddef660a84e19e34bba4073cb9908ba47c3fe658f9134caa25b2a5ff44f8b57d1c27879defbefded1b0778c2f13fa2b1d81f6d4b1bbdedb60f8ee6d2f38eebdea5e9c0c39379370356362cbdf82ea0ccf017d70d43d3961828e1759027d1c85b3991bf0bcd71df634d084861975025fbc3d36802f96631ff0716f303cbf381aaae0c7146c623572d33ce869b003aa81bde66fa7fa53d126d59f9ec3e8758f7a5c88cb5938d2283cee9df43817633aa33af5fdd3b717433e32cb9586b37709ba1b9c9cb1c1a6b7a0bd27f15405e8beed4bb187cb884bbc7f0a96dc3d0918d8d1d960a8689a31a4ad3de2fd7846b8e57cc146d4f98a8fdf961de5e3e8c408f2af860e864f4530d0bf8a01531ff151529fb0b1a9d69b1c2cb57d3e4060be483f789e1cefe5d9f7c21c6fe30fa00fdaebffb9e89dbfc3b7ff5cd1640dc6f8bfbdf333c5e55caf339a365e1c34f7f6f6c0244910a5417617dc80070a6ec359346e886f1d0eda24cfbe25d7713ceb3056129aad920511301838306a9ec60b8a3e593effdb2151fb85be46b310a2c0609d6674de5f643499809e37e45f83519cd026efe31f51fe947d452ac18e18c471e1121b299d4d5a241c8f31be744897ffc1e81d47a3ac4396d063d173469747719aa5bc8f5aadc6fe3dfe8ec59e347f0b517c0161670e06d36600fd0c9984f07f1d2d20341e03666883bc7693245cc3df1071e384051f88be40387818fc779eb6b59e0239b42264d06590ad9714c246f11a6dae783d428a600873290441b488b22010ac8faf3ba40ffe874b26ccc2eb30cd65881f846a0745478057d0dce0af0a8a10598bc0f8af28833d04c7d77421622401222e07150f23ddc20343d9541900d787b2913c48ea3af067d22288bf43b055c1473429c098ba81c44d923a9aa1999cb7c13b36e45741908bb32b09f41e98c4472af1d352e2158a8595946057d1825faf8616d2381602c838a6dcf020f0acc073afe149fe0e5238e83823ff4793d82dc26dc4e790cabe4a3b863fc878d3ea322923435375302581b554b27c8025bca66d33bad80605075730303336dbe7fec2c505c3a40b731dd1d99814dad72a136f53faab22336d301b678e9359fa7785950783a3b3f35ea024a20810887414156646a7e168cd81595678761e9cf40743997cc6493083d45f38219e48f60a189ebf520d8877fa1d84c0ef251ceff81a92970f1a287a86b7e77d9edd303e974984090e7bfd43f7270e72d2ffa1cf1ddf3cbce3a261c97dee1c2f7be703986220c02d9fcc8917fd1fde9e9d0f831fdff4873d490c4ff3838f37307e2a3516709eded82d820f742d3d73effc1238c034e255ff354fe0d87c02b57f124deb8a7895b160e2cdc78283f07c5981e149b30974d94766a1bf639114de46c8327437a626d069f7071d6811cea98819ff6089df2c9e3622981dddd1f1e1f3a6d4edee08e7b6742cec36639310d3687908dd88eb5ce4fe36ae16985b98c68b1d1163d47e8b0a7374031342d9419a3f3643c5166831dcdb5887e5a1a822fe1fc23bece2045558ef03fd254c1e956e58b0dca69f7d650cc7e33ed3dc1f51714f406f21cb2f12237c207a816f47f16ab11543fbea00cfc11f79fb4ad86ba53bfee0537ae453b50137b4236667457fc2fe5ecdc2e9ce0c7173d1472737a223303486b878740a6655a2c4cb245ed2245b17a1c3f228235cebe1c144e6a8eea004794660b5cfe392dd95ee8d8a1e807e5fd4d35ab4a13f3f76cdfb5441ae355071574e61113f4e299454760544359a6dd97c7c5da4a74f72ae94e067a5a84aa0b4925436d181a7e00f6f0e5f9879af1a26ad145a8da916de7c4a6220d462aa85510bc155519ae1d74ef58d985d19b10cd980f2324cf49c9f457677ceef4093cf1de4544c1b450e68847f73188d84a14ad7225f30c817094595798f65892651565ab11356967158e3e64e592a4dd7341b37474f4b69aa8851cd664c01a8998fdbb84c6c5ade63a2d3b2a4aaf8149f63f0aae5535558d552291f32ccbbdcc3207d1d6080995106f33367da02989fef93a74fe1ff251e4f41a27a3c88e724feb8a00962c255ff288bc21911be8aa0424968889b539ab4c7f47a356d4cea05c68e4071486af78c3df6f5a1566f9161f775991fe4136ad9a40265b9d3d3497338c412d438adcdf1a12c09734c5e8fd506f886947929223efb340d280b0490e2bf1a3e3ce0b9382eeeb94a90193ece8b51ec563017e1129b8ad3952e78f8157b21dc2f94f1aca7153e7cb9b59460ca411aba71ac588a57a4145e031080caba0dae676037511ae0ee5890411a17646182999370f88dfa7e7bbf7d506fbad636e6d114d7e982dbfd603f385078ab8cf84505c42f7641fc6505c45fee82f86505c42f7741fc5505c45f35ac553781835929c3f3f7babaf452d2ab98656a0f796eae2f56e36716a6999203e85df3e43407d5b25801923654044df28df95aa742cd740d1d335691f26561fc0c71c3998323955cdd53be212abd135b73f63919151b8cdb8c2e1a66e2d5248787645f1fa827a257e88ced95c6b331ae88c762b590b56b6b2dacc52ff79691de4dae4dd55720754d5188d96251d7e7be3d23f4c21ca16d1cf7760eb982aff510f9a549643105b5815f6ee6c8e5994dc3f5f6f80f4cdfa2d19c6637f1b8682e4d43b34c1541c212fbabf7aacae626aaec28752ccdc3a6a83cd2752c6751d6a8b56b4d5b7db264edd629d67f3b5ce21678037294063e68362d5851fc7189e95d2f49e2c4872e4d4d1792ad9633caf0a6f9bc9ade65b89e3b6b24341cc78bd9fa7098ac68b12091ef700d584abc71734b09c6c54ab1cb755fafa259162df80cb121101ae2e2f91728c524ce5d24fa34e5b16ca8b58327ab19e6b1f7966444f544c7f10a3f3cb7ef10adfac0827cd8f37f031615fadaa24423706c4cdac3c6e9be1234bebfd2cb27708fa304b5210136de1c61e1817611a8ce10326013cf3081cdd20442269bd2332e27581155573ca0298d6a0c61558ba789fa4ac2f362909c41d035be0ac11f170c2aaa2ae61d7c9aa2728e5cd83bd106a14df2b335941814ed862ab9be56827a90332bf8e918e3cae6a785301cd3d62bb597f7a672ea187c3ae8b41dfc60a591cf78f06318505e88e3af37d075bca30db6bf955648d4319872b67ad0cd945aa27d7ce64559d36ebc6f6282ce2257914445d574ebf576ea89714217215f8b3195535da1b932e87b6f68f7a3fa6db7e04da197b95143e6f801a96b6c6ef6e27ad11b70a7b55706d4d4c82722e336dc92a062a7b1c7cf6eae296f5936fef8c989f8545dc00fa3e9135d9e909603953b6ddae002f0b34117f3cf163a997f36e8667963c3273a07c28be0c18f7b93d773f0bad9edbbb8ade6fa1dac3a06d7cfe883f5ca1d0bf0f39732989f1d946163187431bb3114323ab78be90fca549c95ade4ce64c46a750359de272625ac52906f50758f8fcf7b8341cb2c142cd26451142d736b06d776d5077a32eca2b5778e20228b5a8f2d2605b271c1a2630a5069b297af4b57daaf2dd6b4d5bddabc1b893735f196944a3c21489858aa1f850bb6a8bba01f5d2bebf97c729e4edb296595f67f1363cada97cc52fa0b16f7086fd66112676deafa4a634e26f9d65ca4aabaac2f61eda29102d823b89015c33015326a58f876932ab6d10d1d7d2073502d3c9fc0f992af8dbd16056f8728d2933b2ec5337bdbc52175adfa51dd90d96a0494a314756d7ec659e3accbc7e01d966112ce53c75456be6bf0461af145c3cd93d99cc85cec08aed226fa13334cb06c2046e26f178fa9b2185361166ea1351878238a997d73e12d380281cfc36c74a372c55055c8e0380e6dbdcc6eba052de10c1dd35aa83d1d5b34554a067d5495a57f95c8924749ac455d3e0e42d95ab656280dca2c51d317668c1e5d2a8cd220c4353cb998b2bb360ba77a13596f57dfbfab93ff144cb76fe85da3a9aebe0a16732fa4d6e2b714c28b35c142c0f96eae5475f6a0e1d2ee6cbe0ca42f32bc8c4eb7e6b518c20289b9c4ca65236adcda72b0f86447424ea205d62c3b9a6a7d1524fabc36d713afd7f6d51e6ee7c2954efe72e1d55df85f6e6e273757a67c5b78ad5cf5311de77f3d781c9993d7724f26ab7d1d9e2cefd89f698dc75daef4be3d0eede087788babcbf9493bbfa42752d4bdb36e8e0f6651b958eacd0d3ea065e6c458cc8239b1b0d3df3121ce87791b776197e85873207beee616a01c1569431cb54e243f32eb5ca3e20441c29ecf8605598d7aa10175af96f0fae13f82a2ec3814e6684be20512762a61933aeea86e6ee89c026be2be513bd7f12a41208d5e8820ac40218b97f338cd78155c1170e2a5eee2a552c64bbdc404217dd4e1966f84d24a701ed728aa1a54944dc7de6f2e010df02a7a8f25105e394859d8ad90ca4fd67b4da7d55217173457f91b303d1c053d7f3162c43d877ae830a5c2da0ff4fa1e613d98190aca38af1aaca0dc46dfe4d9b36760361c5c0f314ed77f2c2afdfe4cbe3faf4efcdcce5fab9274299d5d46f978ee3fc7bd93ffd7086301e0b840571a01fe10fab2eb80fc1503640c3054f351828086b3340a6890d5c380dd6cc73860e8bfaeda9609f8168da3749335d8d58f86bb2e50148d0b8d3722835881ce55dfadf65614d3797dc430a60fb7338ec91af32a26ea8c64397c8550368cf9695c3c737352f05aeea2d899eddddc142ff779ccc0c68e0b6975e5bfc33a3fb69153588f19aa886b40719d098dccd7f8a2b6d9319ba7a19cfb0906cc2ef1d21f2ef9604901ef14350bda58c864da368ca5be6d0a9daf9278fe67d550ce01af49fe1c5abaab566d1df1ab47505b5f1f25889a684be3a8095c3d943a5bee184d55bbe08ac2d41cf5dd6f1cfea0da5f54b3920ac1b5bf90583e21be9ab2b242ac2280478caf9626b8a78ab8f556d124dc734540a04757c699a75a9fed8d2bfe4940e42749f5fa08eb8eaa0e79bebf1fecefefb73c70daf5541d72f0b21a30bbb20a902374fedfc656fc362b6cf5d516adf2ebac3ae4d9dfabb518f400f84529ec6b04f1bee5080ebcefc5ed571df2b51784df8605341f7ce98561f76381ccfd64ca6bb1d838faa0f27bb2802309f1a0e9ec07ba16a7345173351d6af31b5e9ce797940b5a0003fa2bee9ddd4a6b9e0d313497a33480ae1c177b613f07c1cb4245b641c12eff420c2f8be66e72e5c10f279dfa117eacb738283d24cb406acfdbcfdb07b56d0e3cc883e08c0ad7ad08454d917f44cde1720faa28ead186b278e7afe19104a705c1d52f0c29afb261174ce5a0bf7d5a83dd916fccfa1a517d838c60876577236261aabb64d58d41f881d2e586227f942281a099e37b68917b7ca426919679e6c0f2ce2e0dd2baec4540f301db425dd55b5d3cd7b96ca8e3328d5769febe44ed2a74ecb947c6ab7ea23d61c7f17463f8edf5905baea5884e5482ad059d86ac207ab19a5fdb7a2d8581f9a8ebba44701a6550cc713a0fb1968c98e5466433d7fd3f4a4b315855a799b55c16eaa06de3672f9573b34c4341613c1aaa9f8c75c70efb68a31144c0c7e2f6b472f36e4dd1481830f54ede9b10e7594227503d21965bba68f7291c397453738d9b0f9ed49ed6aa80b3db38d89a00fc51b60c64dc8924cc93e31b64f3cc2e3e71acc6f84ffaffd6c6c8f94e81d00043af1e6aadfa1e13bc4344232e4536b70f14a046210745d9f9b9ca1efb078f7c820254da941052c252057641278409aa2f2ea02cf1ce09af3867f1348096c95a3f7feac8120d4edd39453c1b07c241c1284b39b895cf0cbab231d3e2a7353b4c3e41c358888bbd81370b001d42b4c8735205374eebb88f719cfae6a8d91d0ea6a0702c54fbd306a4dca81c5df88603659d5af096481c1229a1c565b13a39f3f003459a409e389a9c141cfafca230ab8d5497fcb870a3d012e3c4303b27b6917e8fd8b79577bd556fff1a47f9187fb2e8ab89f47797a8eb988114717e15937c204e83836c6c5221e5c90746b5fbfc8324dfb283e5cc989d6a87794bbe8ea713e186d7bacdb9bd752ae6a3e8c4a47e2fc97a68ddd75a35ae229286e643fd37b58aa223ad2091e1b770091f2551b966e09edb0db34469d632d0e877c494ac281a8b532c74e1af0c289268dc17e1eba1899312a40a97f9cca0af84b9874debf27fce84e1df2b635084ab6e35fcbbe40d5512008dfbcdce47ca38e04d1c930077d8e5fd6cef6434a96f0e16f8f9946ca8b2207612c26f10293f43cc7fcc802c04581293ab86ec2ab198c5eef2f06e12a5446c17a8ff2cab46fb63c47da1c04578dd2a2d56d203774a509db3cfadfaeaf01881be2c97f0a52092a5cf926770661e37d328dbe4ac9676d89b9c9f2da227619452e5f625dcc2d48337bb50d9793d2b27c5778d72defe11a2b7e8cf43095b45633de0d119dd916881dc79b8860981afcd899fa4f2b5bfda7f5fb28660c7831b3ecb6fb39fe1c2b32c2886470da7ecf788902dd762829fa94df330e71cccedacdc9d6c65abba556213a9228a34ebd68e3e222ebd21cd6723ecefc210f5bd30972309b476f7cab78792453e69b1bfa6f12298c5e1385509688b1fa16ad47eaed75aa4f673add6fc74a311a54551caee80c29fb56058f4b98e1424b37d5c2ae7a65ffb9eaec97c05aa7b4dd9afeae11afe2fd0f6975ad3524fa31b46678b0d55959e98c3b1fbc2e6bfd4aae44315d7124c2a7da2f012da9bb1290d9278eba6d994cf260d12ca716f3e7ab055dc0451760adc5ed7b3c1cb20841335f6786f8bad5d7792aacb8ac920dd349fbad51349d93dbcc8777352356d35f9960d1486bd09110fb140aa3da5af36ebf470d1e6ad8d846b03527d12a05696f9a6009efa32e4c772daceda3237e2d20a337713516766f5bc414e455b5669568c58c9cd9bce7208e3e712d8fd13f882a93a3c94009359386d34c9bfc8d7de45a095fdbb169b7fd4e28fb6063451892ddfc89dd41d1c77d4f68d7be5cb035eb1bbaf76863bb02857f6cb53aaceb18778032dfe7e84223b8d14d9fa5f87ac8197896f25e863f252606ddce77f3d3455f69680dbbeabdfa977fa6dc540bfab2d1b688f304ab459b670dca7e2fd29164fa3f2240b3f462472489534903908460e1e1fd848b2599222eb7ad976faa390c47e1f98df14d7b0faae3613c3a227cbf41d7131633feeabc544d5c7946bc8f65652d80247ff1fbcd921b7195b588cbc2b7cd7c6f22ff4b02ce95561dcd991a3254fd17380fc065d842b29893957ebd7b01c46fe60cfc2f1433d7f30ffc9745afc5285abe0ce327406fb4dd1aec44589f312638a976da594355593405f811ffeb1b9c60fff30a0cc5f5242447c14b6300a6d38fd3f8f745f673f81d6f14bad45eaec07d02c10c6020379d8fb7f504b0304140000000800d66d254f987786493f0000005c00000022000000676f7665726e616e63652f676f7665726e616e63652f7061636b6167652e6a736f6eabe6520002a5b2d4a2e2ccfc3c252b0525033d033d73251d88786e62665e7c6e7e4a694e2a482e3d1fa8302f312f3915454171727e1158de1d21cf55cb0500504b01021403140000000800d66d254facf2a78f7a01000058020000210000000000000000000000a48100000000676f7665726e616e63652f676f7665726e616e63652f5f5f696e69745f5f2e7079504b01021403140000000800d66d254fad3cec03ef160000717c0000230000000000000000000000a481b9010000676f7665726e616e63652f676f7665726e616e63652f676f7665726e616e63652e7079504b01021403140000000800d66d254f987786493f0000005c000000220000000000000000000000a481e9180000676f7665726e616e63652f676f7665726e616e63652f7061636b6167652e6a736f6e504b05060000000003000300f0000000681900000000'},
                                       'signature': 'I9iNfiAO6Op0vn7ql3XUbtbk0FbH31bfD6w0cMCGmkBbB7b18aGrrPW5rH0D6jfPae6MSwh2J7iI6IVoFsj4UwA=',
                                       'txHash': 'ed7d1b12fecc6d7819c6e152590efefdc699d9e2c944c0c05f262cfa0a0bf59f'}]
        self.tx_v3_hash: bytes = b'ed7d1b12fecc6d7819c6e152590efefdc699d9e2c944c0c05f262cfa0a0bf59f'
        self.tx_v3: bytes = b'v3_tx'
        self.db = MockDB()
        self.db.put(self.tx_v3_hash, self.tx_v3)
        pass

    def test_transaction_parsing_v3(self):
        parser = TransactionParser(self.db)
        parser.transactions = self.v3_transactions
        for actual_txhash, actual_transaction in parser:
            self.assertEqual(self.tx_v3_hash, actual_txhash)
            self.assertEqual(self.tx_v3, actual_transaction)
